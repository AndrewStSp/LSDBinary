# LSDBinary: pushing least-squares deconvolution (LSD) to the next level by generalising it to binary stars

## Motivation
With the amount, and more importantly unprecedented quality of (space-based) photometric and (ground-based) spectroscopic observations available nowadays, considerable time and effort are being spent to improve methods and techniques for the analysis of stars in binary and higher order multiple systems. The need to achieve extremely high signal-to-noise ratio (S/N) to be able to detected low-amplitude magnetic signatures in polarisation spectra has driven development of the Least-Squares Deconvolution (LSD; Donati et al. 1997, MNRAS, 291, 658) multi-line averaging technique. The LSD profiles obtained with this methods are also ideal for inference of radial velocities of stars (including those in binary systems) and to study temporal spectral changes due to intrinsic variability of stars. Here, we present a generalisation of the original LSD method to binary stars. In particular, we focus on the determination of precise, orbital phase-resolved radial velocities (RV) of the individual binary components with a careful treatment of the Rossiter-McLaughlin effect (Rossiter 1924, ApJ, 60, 15; McLaughlin 1924, ApJ, 60, 22).
## Problem formulation
The LSD method is by design sensitive to signals that are common to the majority of spectral lines in stellar spectrum. Therefore, even under the assumption of a single line mask *M*, LSD remains a powerful method for detection of SB2 binary systems. For example, the LSD profile computed from the composite spectrum of a SB2 system and employing a line mask corresponding to the primary component, will contain signatures of both binary components with a caveat that contribution of the secondary component to the LSD profile will be somewhat diluted. Measuring RVs and/or studying line profile variations (LPV) of individual binary components in these composite LSD profile still proves nearly as difficult as from the original observed composite spectra because, despite the significantly enhanced S/N in the LSD profile, line blending remains the dominant source of uncertainty. In practice, this means that the original LSD method as well as its numerous generalisations (e.g., Kochukhov et al. 2010, A&A, 524, A5; Sennhauser et al. 2009, A&A, 507, 1711; Sennhauser & Berdyugina 2010, A&A, 522, A57; Tkachenko et al. 2013, A&A, 560, A37; Asensio Ramos & Petit 2015, A&A, 583, A51; Strachan & Anglada-Escud√© 2017, MNRAS, 472, 3467), despite being effective for the detection of SB2 systems, are however not suitable for the calculation of LSD profiles of the individual binary components and inference of their precise RVs thereof.
Here, we ocus on separation of spectral contributions of the individual binary components in velocity space to the level of precision that would enable inference of precise and accurate RVs of both stars and, if possible, resolving their LPVs. In doing so, we focus primarily on the difficult case of the in-eclipse orbital phases that are characterised by high degree of blending, while we pay little attention to the out-of-eclipse phases where spectral contributions of the two stars can typically be easily separated from each other. This specific focus on the in-eclipse spectra is made solely for the purpose of demonstrating the algorithm's performance in the most difficult circumstances, while the algorithm is designed such as to handle all orbital phases in the spectroscopic observations of eclipsing SB2 systems. As a baseline, we adopt the modified LSD method by Tkachenko et al. (2013) that employs a modified, fast version of the Levenberg-Marquardt algorithm (Marquardt 1963, SIAM Journal on Applied Mathematics, 11, 431) implemented by Piskunov & Kochukhov (2002, A&A, 381, 736). The algorithm has the capabilities as outlined in Tkachenko et al. (2013) and serves as the ``central engine'' of the **LSDBinary** software package presented here.
## Brief description of the **LSDBinary** software package
Figure below provides a flow chart of the **LSDBinary** software package with the three main components - input, central engine, output - being indicated.
![Box_diagram](https://user-images.githubusercontent.com/19326373/181260427-b940b29e-8b1d-4918-b09e-a2a9d9b2da6e.jpeg)
Figure 1: the **LSDBinary** software package flow chart. Bottom left panels show output of the *LSDinit* program in terms of the LSD profiles computed from synthetic spectra (left) and continuum flux ratio of the two binary components as a function of the wavelength (right). The output of the *LSDBinary* program is illustrated in the two bottom right panels showing LSD profiles of the individual binary components (left) and a comparison between the composite observed (black) and LSD-based model (red) spectra of the binary. See Tkachenko et al. (2022, A&A, submitted) for more details.

Here, we provide a more detailed description of the entire process, in the form of a pseudo-code:
* The *LSDinit* algorithm comprises three (optionally four) major steps (see below), whose purpose is to take care of all necessary preparations for the core calculations with the **LSDBinary** algorithm. In this module, we set up initial guesses for the individual LSD profiles, wavelength-dependent flux ratio of the two stars, and pre-compute local corrections to the LSD model spectrum to ensure its closest match to the observations. The three (optionally four) above-mentioned steps are:
  - The *SynthV* radiative transfer code (Tsymbal 1996, ASP Conference Series, 108, 198) is employed to compute synthetic spectra in an arbitrary wavelength range, with options for variable microturbulent velocity and chemical composition of the star, including possibility for their vertical stratification. Spectra are synthesised for different positions on the stellar disk to account for center-to-limb intensity variations, also known as the limb darkening effect. The *SynthV* code is publicly available and its latest version is distributed as part of the **LSDBinary** package. However, *SynthV* can also be replaced with any other one's favourite radiative transfer code provided its output is tuned to the input requirements of the **LSDBinary** code.
  - The *Convolve* code (Tsymbal 1996, ASP Conference Series, 108, 198) performs integration of specific intensities over the visible stellar disk and the convolution of the obtained spectrum with the Gaussian profile with the Full Width at Half Maximum (FWHM) corresponding to resolving power *R* of the instrument, the projected rotational velocity vsini of the star, and optionally the macroturbulent velocity.
  - The Rossiter-McLaughlin Effect (*RME*) algorithm can be used as an alternative to calculation of the disk-integrated synthetic spectra with the *SynthV* and *Convolve* suit of codes and is therefore an optional step. The *RME* algorithm, as the name suggests, allows us to compute time-series of the in-eclipse synthetic spectra subject to distortion caused by the Rossiter-McLaughlin effect and the associated variable with orbital phase binary components' flux ratio. The *RME* algorithm relies on orbital configuration of the system as input and delivers distorted line profiles and orbital phase-dependent components' flux ratio to be used for the calculation of initial guess LSD profiles for the in-eclipse phases. Therefore, the option of using the *RME* algorithm is best suitable for binary systems whose orbital configuration is know in advance, though the algorithm does not require the orbital parameters to be know with particularly high precision and/or accuracy.
  - The *LSDsynth* algorithm is designed to compute theoretical LSD profiles for both binary components from the corresponding disk-integrated synthetic spectra (with or without the RME taken into account) and line masks. Due to the natal assumptions and limitations of the original LSD method, the LSD-based model spectrum computed by means of the convolution of the LSD profile with the line mask fails to closely reproduce the input stellar spectrum the LSD profile is computed from. The *LSDsynth* algorithm developed by us overcomes that problem by computing and applying local corrections to line intensities in the LSD-based model spectrum such as to provide its closest match to the input synthetic stellar spectrum. These relative intensity corrections take the following form (r_synthetic-r_model)/r_model, where *r* stands for the normalised flux while 'synthetic' and 'model' refer to the input synthetic and LSD-based model stellar spectrum, respectively. Lastly, the *LSDsynth* algorithm computes the ratio of binary component's fluxes as a function of wavelength and approximates it with the polynomial of second degree. Summarising, taking synthetic spectra and line masks as input, the *LSDsynth* algorithm delivers: (i) initial guess synthetic spectra-based LSD profiles, (ii) local fractional intensity corrections to the LSD-based model spectrum, and (iii) best fit polynomial coefficients that allow one to reproduce the wavelength-dependent functional form of the components' flux ratio.
* The *LSDBinary* algorithm represents the 'core engine' of the method and allows us to compute time series of the LSD profiles of both binary components separated in velocity space.
  - *Input:* the algorithm relies on the output of the *LSDinit* module in terms of the initial guess for: (i) the synthetic spectrum-based LSD profiles of both binary components, (ii) local fractional intensity corrections to the LSD-based model spectra of both stars, and (iii) functional form of the components' flux ratio. In addition to the above, the *LSDBinary* algorithm also requires initial guess for the RVs of both binary components, that can be provided either in the form of a table, RV vs. orbital phase, or in the form of orbital parameters of the binary system. In the latter case, orbital phase resolved RVs are computed from the provided orbital elements within the *LSDBinary* module and are employed as the initial guess. Lastly, *LSDBinary* requires two line masks, one for each binary component, to be provided as well.
  - *Core calculations:* *LSDBinary* utilizes the LSD algorithm implemented in Tkachenko et al. (2013), in particular its functionality to compute multi-component LSD profiles with the employment of multiple line masks. We modify the algorithm such as to account for relative contributions of the two binary components to the system's composite spectrum. These contributions are defined by the component's flux ratio whose wavelength-dependent functional form is pre-computed within the *LSDinit* module and their radii ratio. The latter parameter can be either fixed (e.g., if it is known from the binary light curve solution) or used as a free parameter in *LSDBinary*. The problem of solving for the individual LSD profiles is approached in iterative fashion with the employment of the modified version of the Levenberg-Marquardt algorithm. In each iteration, the algorithm minimises the difference between the input observed composite spectrum of the binary system and its LSD-based composite model spectrum counterpart. The latter is computed as a linear sum of the individual binary components' model spectra that are subject to their local fractional intensity corrections before being added up.
  - *Output:* The *LSDBinary* algorithm has Level-0 and Level-1 output. The former refers to the individual LSD profiles and the LSD-based model spectra. These model spectra are provided for: (i) both binary components separately and are the product of the convolution of the primary and secondary LSD profiles with their respective line masks, and taking the individual fractional intensity corrections into account, and (ii) the binary system as a whole, where the composite model spectrum is represented by the linear sum of the primary and secondary LSD-based model spectra with the components' flux and radii ratio being taken into account. On the other hand, the Level-1 output refers to the quantities inferred directly from the LSD profiles and the process of their calculation, i.e. from the Level-0 output. These quantities are the RVs of both binary components and, in case it is set as a free parameter, radii ratio of the two stars as a function of the orbital phase. Individual RVs are computed by matching the components' LSD profiles to the respective initial guess synthetic spectrum-based LSD profiles with the employment of the golden search algorithm (Kiefer 1953, Proceedings of the American Mathematical Society, 4, 502). Therefore, RVs delivered by the *LSDBinary* algorithm are on the scale relative to the initial guess LSD profiles.

Figure below provides an illustration of the application the the *LSDBinary* algorithm to simulated in-eclipse data of an Algol-type binary system.
![LSD_demonstration](https://user-images.githubusercontent.com/19326373/181460061-2541d9e7-2cc2-4679-8549-7c6dcd5beb55.jpeg)
Figure 2: graphical presentation of the *LSDBinary* algorithm. **Left:** initial guess synthetic LSD profiles computed with the *LSDinit* module with (red stars) and without (black dots) the RM effect, along with the resulting 'observed' LSD profile (black solid line) computed with the *LSDBinary* module. **Middle:** the in-eclipse phase resolved RV-curves with (red stars) and without (black dots) the RM effect. The RVs measured relative to the respective initial guess LSD profiles are indicated with the arrows. **Right:** radii ratio as a function of orbital phase with (red stars) and without (black dots) the RM effect taken into account in the computation of the initial guess synthetic spectrum-based LSD profiles. Arrows indicate the same data points as in the middle panel. See Tkachenko et al. (2022, A&A, submitted) for more details.
## Installation
I will provide details here; place holder for the moment.
## Publication
Details of the algorithm as well as its extensive tests on simulated data are published in Tkachenko et al. (2022, A&A, submitted). **We kindly ask any user of the _LSDBinary_ software package to cite Tkachenko et al. (2022, A&A, submitted) in their own publications.**
